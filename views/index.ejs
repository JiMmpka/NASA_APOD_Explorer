<%- include('partials/header') %>

    <main>
      <!-- Date Selection Section -->
      <div class="form-section">
        <h2>ğŸ“… Select Date:</h2>
        <form action="/get-date-picture" method="POST">
          <input type="date" 
                 name="date" 
                 id="dateInput" 
               lang="pl-PL"
                 max="<%= new Date().toISOString().split('T')[0] %>"
                 min="1995-06-16"
                 value="<%= data ? data.date : new Date().toISOString().split('T')[0] %>"
                 required>
          <button type="submit" class="btn-primary"><span>ğŸ”­ Show Picture</span></button>
        </form>
        <a href="/random" class="btn-secondary"><span>ğŸ² Random Picture</span></a>
        <a href="/" class="btn-secondary"><span>ğŸ“† Today's Picture</span></a>
      </div>

      <!-- Content Display Wrapper (for loading animation) -->
      <div class="content-display-wrapper">
        <!-- Loading Overlay -->
        <div id="loader-overlay" class="loader-overlay">
          <div class="loader-content">
            <div class="spinner"></div>
            <p>ğŸš€ Traveling through space to NASA servers...</p>
          </div>
        </div>

        <!-- NASA APOD Data Display Section -->
        <div id="apod-container" class="space-data-section hidden-initially">
          <div class="apod-header">
            <h2 id="apod-title"></h2>
            <p class="apod-date">ğŸ“… Date: <span id="display-date"></span></p>
            <p id="apod-copyright" class="apod-copyright"></p>
          </div>
          
          <div id="media-container" class="space-image-container">
            <!-- Will be filled by JS -->
          </div>
          
          <div class="space-fact-container">
            <h3>ğŸ“– Description:</h3>
            <div class="space-fact-scrollable">
              <p id="apod-explanation" class="space-explanation"></p>
            </div>
          </div>
        </div>

        <!-- Error Section -->
        <div id="error-container" class="error-section <%= error ? '' : 'hidden-initially' %>">
          <h3>âŒ Oops! Something went wrong</h3>
          <p id="error-message"><%= error %></p>
          <a href="/" class="btn-secondary"><span>ğŸ”„ Try Again</span></a>
        </div>
      </div>
    </main>

    <script>
      async function loadData() {
        const loader = document.getElementById('loader-overlay');
        const apodContainer = document.getElementById('apod-container');
        const errorContainer = document.getElementById('error-container');
        const errorMessage = document.getElementById('error-message');
        const initialDate = "<%= typeof initialDate !== 'undefined' ? initialDate : '' %>";
        const hasServerError = "<%= error ? 'true' : 'false' %>";

        // JeÅ›li serwer juÅ¼ wyrenderowaÅ‚ bÅ‚Ä…d (walidacja), nie rÃ³b nic
        if (hasServerError === "true") {
          loader.classList.remove('visible');
          return;
        }
        
        loader.classList.add('visible');
        apodContainer.classList.add('hidden-initially');
        errorContainer.classList.add('hidden-initially');

        const url = initialDate ? `/api/date/${initialDate}` : '/api/today';

        try {
          const response = await fetch(url);
          const data = await response.json();

          if (!response.ok) throw new Error(data.error || 'Failed to fetch');

          // Title & Date
          document.getElementById('apod-title').textContent = data.title;
          document.getElementById('display-date').textContent = data.date;
          
          // Copyright
          const copyright = document.getElementById('apod-copyright');
          if (data.copyright) {
            copyright.textContent = `ğŸ“¸ Â© ${data.copyright}`;
            copyright.style.display = 'block';
          } else {
            copyright.style.display = 'none';
          }

          // Media
          const mediaContainer = document.getElementById('media-container');
          mediaContainer.innerHTML = '';
          if (data.media_type === 'image') {
            mediaContainer.innerHTML = `
              <a href="${data.hdurl || data.url}" target="_blank">
                <img src="${data.url}" alt="${data.title}" class="space-image">
              </a>
              <p class="image-hint">ğŸ’¡ Click on the image to view in full resolution</p>`;
          } else if (data.media_type === 'video') {
            mediaContainer.innerHTML = `
              <div class="video-container">
                <iframe src="${data.url}" frameborder="0" allowfullscreen class="space-video"></iframe>
              </div>`;
          }

          // Explanation
          document.getElementById('apod-explanation').textContent = data.explanation;

          // Show content
          loader.classList.remove('visible');
          apodContainer.classList.remove('hidden-initially');

        } catch (err) {
          loader.classList.remove('visible');
          document.getElementById('error-message').textContent = err.message;
          errorContainer.classList.remove('hidden-initially');
        }
      }

      window.addEventListener('load', loadData);
    </script>
<%- include('partials/footer') %>
